{{- define "main" -}}
    {{- partial "home_info.html" . -}}
    
    <div class="command-center">
    
        <div class="countdown-container">
            <div class="countdown-header">
                <h3 class="column-label">{{ i18n "countdown_title" }}</h3>
                <span class="info-trigger" title='{{ i18n "countdown_info" }}'>{{ i18n "countdown_info" }}</span>
            </div>
    
            <div id="countdown-timer" class="timer-display">
                <span id="days">000</span>d <span id="hours">00</span>h <span id="minutes">00</span>m <span id="seconds">00</span>s
            </div>
    
            <p class="timer-subtext">{{ i18n "countdown_subtext" }}</p>
        </div>

        <div class="pixel-map-wrapper">
            {{ partial "map.html" . }}

            {{ $registeredNodes := .Site.Data.nodes }}
    
            {{ range .Site.Data.map_locations }}
                {{ $mapCity := . }}
                {{ range $registeredNodes }}
                    {{/* Lowercase both and trim spaces to force a match */}}
                    {{ if eq (lower (trim .city " ")) (lower (trim $mapCity.city " ")) }}
                        <div class="node-overlay" 
                             style="{{ printf "top: %v%%; left: %v%%;" $mapCity.top $mapCity.left | safeCSS }}"
                             title="{{ .name }} - {{ .status | upper }}">
                        </div>
                    {{ end }}
                {{ end }}
            {{ end }}
        </div>
    </div>

<script>
    (function() {
        const targetDate = new Date("January 1, 2027 00:00:00").getTime();

        const timerFunc = function() {
            const now = new Date().getTime();
            const distance = targetDate - now;

            if (distance < 0) {
                document.getElementById("countdown-timer").innerHTML = "WINDOW ACTIVE";
                return;
            }

            document.getElementById("days").innerText = Math.floor(distance / (1000 * 60 * 60 * 24)).toString().padStart(3, '0');
            document.getElementById("hours").innerText = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)).toString().padStart(2, '0');
            document.getElementById("minutes").innerText = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
            document.getElementById("seconds").innerText = Math.floor((distance % (1000 * 60)) / 1000).toString().padStart(2, '0');
        };

        setInterval(timerFunc, 1000);
        timerFunc(); // Initial call
    })();
</script>

    <div class="registry-grid">
        
        <div class="col-left">
           <h3 class="column-label">Field Reports</h3>
            {{/* Try targeting the section specifically by its object */}}
            {{ range (where .Site.RegularPages "Section" "reports") }}
            <article class="post-entry">
                <header class="entry-header">
                    <h2>{{ .Title }}</h2>
                </header>
                <div class="entry-content">
                    <p>{{ .Summary | truncate 120 }}</p>
                </div>
                <a class="entry-link" href="{{ .Permalink }}"></a>
            </article>
            {{ end }}
        </div>

        <div class="col-right">
            <h3 class="column-label">System Protocols</h3>
            {{ range (where .Site.RegularPages "Section" "docs") }}
            <article class="post-entry">
                <header class="entry-header">
                    <h2>{{ .Title }}</h2>
                </header>
                <div class="entry-content">
                    <p>{{ .Summary | truncate 120 }}</p>
                </div>
                <a class="entry-link" href="{{ .Permalink }}"></a>
            </article>
            {{ end }}
        </div>
    </div>
    
{{- end -}}
